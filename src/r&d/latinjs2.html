<html>
<head>
	<title>MORE Random Latin Squares in JS</title>
<style type="text/css">

#controls {
	width: 100%;
	text-align: center;
	margin-bottom: 20px;
}

#latinsquare {
	text-align:center;
}

#supersquare {
	background-color: black;
	color:black;
	font-weight: bold;
	margin: 0 auto;
}

#supersquare td {
	padding: 10px;
	border: solid white 1px;
	text-align:center;
}
</style>
</head>
<body>

<div id="controls">
	Size: <input type="text" id="size" value="13" />
	<input type="button" name="click" value="Generate" onclick="generate()"/><br />
	<input type="checkbox" id="simcrypto" /> Simulate cryptographic RNG (5000+ floating point operations per number)<br />
</div>

<div id="latinsquare"></div>
<div id="stacktrace"></div>

<script language="JavaScript">
var ls;
var startTime;
var stackhistory;
var simCrypto;
function generate()
{
	var size = parseInt(document.getElementById("size").value);
	if(size < 1)
	{
		alert('Integers greater than zero only please.');
		return;
	}
	simCrypto = document.getElementById("simcrypto").checked;
	startTime = new Date().getTime();
	stackhistory = [];
	var latin = getRandomLatinSquare(size);
	var timeTaken = new Date().getTime() - startTime;
	document.getElementById("latinsquare").innerHTML = formatLatinSquare(latin);
	document.getElementById("latinsquare").innerHTML += "<center>Completed in " + (timeTaken/1000) + "s</center>";
	document.getElementById("stacktrace").innerHTML = formatHistory(stackhistory, size);
	stackhistory = null;
	ls = null;
	starttime = null;
}

function getRandomLatinSquare(n)
{
	ls = new Array(n);
	for(var i = 0; i < n; i++)
	{
		ls[i] = new Array(n);
	}
	
	for(var i = 0; i < n; i++)
	{
		for(var j = 0; j < n; j++)
		{
			ls[i][j] = 0; //Math.floor(Math.random() * n);
		}
	}
	makeLatin(n, 0);
	return ls;
}

function makeLatin(n, position)
{
	stackhistory.push(position);

	if(position == n * n)
		return true;
		
	var row = Math.floor(position / n);
	var col = position % n;
	
	var oldValue = ls[row][col];

	var randomOrder = getRandomOrder(n);
	for(var c = 0; c < n; c++)
	{
		ls[row][col] = randomOrder[c];

		var dupeFound = false;
		for(var i = 0; i < col && !dupeFound; i++)
		{
			if(ls[row][col] == ls[row][i])
			{
				dupeFound = true;
			}
		}

		for(var i = 0; i < row && !dupeFound; i++)
		{
			if(ls[row][col] == ls[i][col])
			{
				dupeFound = true;
			}
		}

		if(!dupeFound)
		{
			if(makeLatin(n, position+1))
			{
				return true;
			}
			stackhistory.push(position);
		}
	}

	ls[row][col] = oldValue;
	return false;
}

function getRandomOrder(n)
{
	var symbols = new Array(n);
	for(var i = 0; i < n; i++)
	{
		symbols[i] = i;
	}
	var order = new Array(n);
	var j = n;
	for(var i = 0; i < n; i++)
	{
		order[i] = symbols.splice(Math.floor(Math.random() * j), 1)[0];
		if(simCrypto)
			simCryptoAlg();
		j--;
	}
	return order;
}

function simCryptoAlg() 
{
	//this code's only purpose is to waste time
	var a = 239482;
	var b = 9230842;
	var c = 2394782;
	var d = 2738947;
	for(var i = 0; i < 500; i++)
	{
		a = Math.log(Math.cos(Math.sin(Math.exp(a * Math.random()))));
		a = Math.log(Math.cos(Math.sin(Math.exp(a * b))));
		a = Math.log(Math.cos(Math.sin(Math.exp(a * c))));
		a = Math.log(Math.cos(Math.sin(Math.exp(a * d))));
		a = Math.log(Math.cos(Math.sin(Math.exp(b * a * c * d))));
		a = Math.log(Math.cos(Math.sin(Math.exp(a + b - c * d))));
		a = Math.log(Math.cos(Math.sin(Math.exp(c * c * d * a))));
		a = Math.log(Math.cos(Math.sin(Math.exp(a * b * c - d))));
		a = Math.log(Math.cos(Math.sin(Math.exp(300000 * a * Math.random()))));
		if(a % 2 == 0)
		{
			a += b;
		}
		else if ( c == d)
		{
			c = c * d;
		}
		if(Math.random() < 0.5)
		{
			c = c * c;
		}
		d += a;
		c -= b;
		a = (a * a) - b + Math.cos(a * b * c * d) + Math.log(a * b * c * d);
	}
}

function formatLatinSquare(square)
{
	var n = square.length;
	var huestep = 1 / n;
	
	var strcat = [];
	strcat.push("<table id=\"supersquare\">");
	for(var i = 0; i < square.length; i++)
	{
		strcat.push("<tr>");
		for(var j = 0; j < square[i].length; j++)
		{
			var hue = huestep * square[i][j];
			var rgb = hsv2rgb(hue, 1, 1);
			strcat.push("<td style=\"background-color: rgb(" + rgb['red'] + ", " + rgb['green'] + ", " + rgb['blue'] + ");\">");
			strcat.push(square[i][j]);
			strcat.push("</td>");
		}
		strcat.push("</tr>");
	}
	strcat.push("</table>");
	return strcat.join('');
}

function formatHistory(stackhistory, n)
{
	var hist = [];
	hist.push("<div style=\"background-color:white;\">");
	var histstep = 600 / (n * n + 1);
	var histHeight = 300 / (n * n); //Doesn't work fully in IE, it won't do 1px high divs.
	var histHueStep = 0.3 / (n * n); // from red to green
	var depthChanges = stackhistory.length;
	while(stackhistory.length >= 1)
	{
		var depth = stackhistory.shift();
		var width = (depth+1) * histstep;
		var hue = depth * histHueStep;
		var rgb = hsv2rgb(hue, 1, 0.8);
		hist.push("<div style=\"width: " +
			Math.ceil(width) + "px; height: "+
			Math.ceil(histHeight) +"px; background-color: rgb(" + 
			rgb['red'] + ", " + rgb['green'] + ", " + rgb['blue'] + ");\">&nbsp;</div>");
	}
	hist.push("</div>");
	hist.push("<p>Total: " + depthChanges + "</p>");
	return hist.join('');
}

//Taken from: http://jsres.blogspot.com/2008/01/convert-hsv-to-rgb-equivalent.html
function hsv2rgb(h,s,v) {
// Adapted from http://www.easyrgb.com/math.html
// hsv values = 0 - 1, rgb values = 0 - 255
var r, g, b;
var RGB = new Array();
if(s==0){
  RGB['red']=RGB['green']=RGB['blue']=Math.round(v*255);
}else{
  // h must be < 1
  var var_h = h * 6;
  if (var_h==6) var_h = 0;
  //Or ... var_i = floor( var_h )
  var var_i = Math.floor( var_h );
  var var_1 = v*(1-s);
  var var_2 = v*(1-s*(var_h-var_i));
  var var_3 = v*(1-s*(1-(var_h-var_i)));
  if(var_i==0){ 
    var_r = v; 
    var_g = var_3; 
    var_b = var_1;
  }else if(var_i==1){ 
    var_r = var_2;
    var_g = v;
    var_b = var_1;
  }else if(var_i==2){
    var_r = var_1;
    var_g = v;
    var_b = var_3
  }else if(var_i==3){
    var_r = var_1;
    var_g = var_2;
    var_b = v;
  }else if (var_i==4){
    var_r = var_3;
    var_g = var_1;
    var_b = v;
  }else{ 
    var_r = v;
    var_g = var_1;
    var_b = var_2
  }
  //rgb results = 0 รท 255  
  RGB['red']=Math.round(var_r * 255);
  RGB['green']=Math.round(var_g * 255);
  RGB['blue']=Math.round(var_b * 255);
  }
return RGB;  
};

</script>

</body>
</html>
